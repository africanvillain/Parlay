{{- /*
Ingress traffic behavior is controlled by:
- .Values.deploymentMode : stable | canary | cutover
- .Values.activeEnv      : blue | green
*/ -}}

{{- $mode := default "stable" .Values.deploymentMode }}
{{- $env := default "blue" .Values.activeEnv }}
{{- $stableSvc := printf "parlay-analyzer-stable-%s" $env }}
{{- $canarySvc := printf "parlay-analyzer-canary-%s" $env }}
{{- $weight := default 10 .Values.canary.weight }}

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: parlay-analyzer
  namespace: default
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/healthcheck-path: "/health"
    alb.ingress.kubernetes.io/success-codes: "200"
    alb.ingress.kubernetes.io/actions.parlay-analyzer-forward: >
      {"type":"forward","forwardConfig":{"targetGroups":[
{{- if eq $mode "canary" }}
        {"serviceName":"{{ $stableSvc }}","servicePort":80,"weight":{{ sub 100 ($weight | int) }}},
        {"serviceName":"{{ $canarySvc }}","servicePort":80,"weight":{{ $weight | int }}
{{- else if eq $mode "cutover" }}
        {"serviceName":"{{ $stableSvc }}","servicePort":80,"weight":100}
{{- else }}
        {"serviceName":"{{ $stableSvc }}","servicePort":80,"weight":100}
{{- end }}
      ]}}
  labels:
    app.kubernetes.io/managed-by: Helm
spec:
  ingressClassName: alb
  rules:
    - http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: parlay-analyzer-forward
                port:
                  name: use-annotation
